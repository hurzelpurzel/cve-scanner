#!/bin/bash

# Prerequisites:
# * expose route to internal Registry
# * edit EXTERNAL_REGISTRY_URL
# * install trivy (https://aquasecurity.github.io/trivy/v0.21.2/getting-started/installation/) on bastion host
# * log in to registry (docker login <exposed image registry>)


#### BEGIN ####

# get all images
echo "Getting all images..."

RED='\033[0;31m'
NC='\033[0m'
INTERNAL_REGISTRY_URL=image-registry.openshift-image-registry.svc:5000
EXTERNAL_REGISTRY_URL=<exposed image registry url>
IMAGES=$(oc get pods --all-namespaces -o jsonpath='{range .items[*]}{.spec.containers[*].image}{" "}' | tr " " "\n" | sort -u | grep ${INTERNAL_REGISTRY_URL})

for IMAGE in ${IMAGES}; do
    SCANIMAGE=$(echo ${IMAGE} | sed "s/${INTERNAL_REGISTRY_URL}/${EXTERNAL_REGISTRY_URL}/")
    docker pull --quiet ${SCANIMAGE}

    RESULT=$(trivy image --severity CRITICAL ${SCANIMAGE})

    if echo ${RESULT} | grep -q "CVE-2021-44228" ; then
        echo -e "${RED}${SCANIMAGE} is vulnerable, please patch!${NC}"
    fi

    docker rm ${SCANIMAGE}
done
