
FROM quay.io/openshift/origin-cli as builder

FROM registry.access.redhat.com/ubi8/ubi:8.0
RUN dnf -y install ca-certificates curl bash podman skopeo kubectl

#needed for version check HTTPS request
#COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

# create the /tmp dir, which is needed for image content cache


RUN curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin \
    && mkdir  /grype_dir \
    && chown 1001:root /grype_dir  \
    && chmod -R "g+rwX" /grype_dir 

COPY  --from=builder /usr/bin/oc /usr/bin/oc
RUN chmod "g+rwX" /usr/bin/oc 

ARG BUILD_DATE
ARG BUILD_VERSION
ARG VCS_REF
ARG VCS_URL


LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date=$BUILD_DATE
LABEL org.label-schema.name="grype"
LABEL org.label-schema.description="A vulnerability scanner for container images and filesystems"
LABEL org.label-schema.vcs-url=$VCS_URL
LABEL org.label-schema.vcs-ref=$VCS_REF
LABEL org.label-schema.vendor="Anchore, Inc."
LABEL org.label-schema.version=$BUILD_VERSION
ENV GRYPE_DB_CACHE_DIR /grype_dir
ENV HOME /grype_dir
COPY ./*.sh /grype_dir 
#COPY ./scan.sh /grype_dir 
#COPY ./update_cvedb.sh /grype_dir 
RUN chmod "g+rwx" /grype_dir/*.sh 
USER 1001
WORKDIR /grype_dir
# Workaround to keep container running
ENTRYPOINT sleep infinity

