
FROM registry.access.redhat.com/ubi8/ubi:8.0 as grype

RUN dnf -y install ca-certificates curl

#needed for version check HTTPS request
#COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

# create the /tmp dir, which is needed for image content cache
#WORKDIR /tmp

RUN curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin \
    && mkdir  /grype_dir 
   


ARG BUILD_DATE
ARG BUILD_VERSION
ARG VCS_REF
ARG VCS_URL

LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date=$BUILD_DATE
LABEL org.label-schema.name="grype"
LABEL org.label-schema.description="A vulnerability scanner for container images and filesystems"
LABEL org.label-schema.vcs-url=$VCS_URL
LABEL org.label-schema.vcs-ref=$VCS_REF
LABEL org.label-schema.vendor="Anchore, Inc."
LABEL org.label-schema.version=$BUILD_VERSION

COPY ./scan.sh /grype_dir 
RUN chown 1001:root /grype_dir  \
    && chmod  -R "g+rwX" /grype_dir  
USER 1001

# Workaround to keep container running
ENTRYPOINT sleep infinity

