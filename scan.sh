#!/bin/bash

DATE=$(date +%Y-%m-%dT%H:%M:%S)

# $1 arg is the value to grep from output
if [[ "$1" == "" ]]; then
  GREP_OUTPUT=""
else
  GREP_OUTPUT="$1"
fi

# request namespace
echo "enter namespace (for all namespaces press only enter):"
read NAMESPACE

if [[ "$NAMESPACE" == "" ]]; then
  NAMESPACE="all namespaces"
  NAMESPACE_SYNTAX="--all-namespaces"
else
  NAMESPACE_SYNTAX="-n $NAMESPACE"
fi

REGISTRY_HOST=$(oc get route default-route -n openshift-image-registry --template='{{ .spec.host }}')
IMAGES=$(oc get pods $NAMESPACE_SYNTAX -o jsonpath='{range .items[*]}{.spec.containers[*].image}{" "}' | tr " " "\n" | sort -u)

printf "\nimages found in namespace\n$NAMESPACE:$IMAGES\n"

# scan images and write results to log file
for IMG in ${IMAGES}; do
  if [[ $(grep '.*openshift-image-registry.svc:[0-9]*' <<< $IMG | wc -l) == 1 ]]; then
    IMG=$(sed 's/.*openshift-image-registry.svc:[0-9]*//' <<< $IMG)
    IMG="$REGISTRY_HOST$IMG"
    GRYPE_STRING="$IMG"
  else
    GRYPE_STRING="docker:$IMG"
  fi
  echo ""
  echo "scanning $IMG"
  RESULT=$(grype $GRYPE_STRING --scope all-layers | grep -i "$GREP_OUTPUT")
  if [[ ! -z "$RESULT" ]]; then
    LOG=$(sed 's/\//-/g' <<< $DATE-$GREP_OUTPUT-$NAMESPACE-$IMG)
    echo "$RESULT" | tee ./$LOG.log
  fi
  docker image rm $IMG &> /dev/null
done
